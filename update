<app-common-dialog
  [header]="'Custom Tables'"
  [showHeader]="true"
  [showFooter]="false"
  [visible]="visible"
  (close)="onClose()"
  [width]="'xl'"
>
  <div class="custom-table-wrapper">
    <div
      class="head-section d-flex align-items-center column-gap-2 mb-2 justify-content-end flex-wrap row-gap-2"
    >
      <button class="outline-btn">Total</button>
      <button class="outline-btn">Summary Statistics</button>
      <button class="button-excel d-flex align-items-center column-gap-1">
        <img
          src="./assets/images/questions/download-icon.svg"
          alt="download-icon"
        />Excel
      </button>

      <div>
        <app-custom-dropdown
          [options]="positions"
          [(ngModel)]="selectedPosition"
          placeholder="Select Position"
        >
        </app-custom-dropdown>
      </div>

      <div class="d-flex align-items-center column-gap-2">
        <div class="mb-2">Hide</div>
        <p-inputSwitch
          [(ngModel)]="isHideEnabled"
          (ngModelChange)="toggleVisibility()"
          id="visibilityToggle"
        ></p-inputSwitch>
      </div>

      <div class="mode-toggle">
        <div
          class="toggle-option"
          [class.active]="mode === 'normal'"
          (click)="setMode('normal')"
        >
          Normal
        </div>

        <div
          class="toggle-option"
          [class.active]="mode === 'compact'"
          (click)="setMode('compact')"
        >
          Compact
        </div>
      </div>
    </div>
    <div class="d-flex w-100 border-rd-12 question-drag-section">
      <div class="left-question-section">
        <!-- left side  -->
        <div
          class="question-card font-l-medium text-bs-dark border-top-0 border-start-0"
        >
          Variables
        </div>

        <div class="search-section border-top-0 border-bottom-0">
          <div
            *ngIf="showSearch"
            class="d-flex align-items-center bg-bs-light px-3 py-2 shadow-sm cursor"
            (click)="focusSearchInput()"
          >
            <img
              src="../assets/images/login/search.svg"
              class="rounded-circle"
              alt="Search Icon"
            />
            <input
              #searchInput
              type="text"
              class="form-control-search border-0 custom-placeholder ms-2 search"
              placeholder="Search ..."
            />
          </div>
        </div>
        <div
          cdkDropList
          id="questionList"
          [cdkDropListData]="questions"
          [cdkDropListConnectedTo]="['columnList', 'rowList']"
        >
          <!-- questions section -->
          @for(q of questions; track q.id){
          <div
            class="question-card pointer font-base-medium text-bs-dark"
            [class.active]="selectedQuestionId === q.id"
            (click)="selectQuestion(q.id)"
            cdkDrag
            [cdkDragData]="q"
          >
            {{ q.id }}. {{ q.question }}
          </div>
          }

          <div class="question-card font-l-medium text-bs-dark">Answers</div>

          <div class="question-card border-bottom-0 border-start-0">
            <!-- answers section -->
            @if(selectedAnswers.length > 0){ @for(ans of selectedAnswers; track
            ans){
            <div class="answer-card font-base-medium text-bs-dark">
              {{ ans }}
            </div>
            } } @else {
            <div class="text-muted small">
              Select a question to view answers
            </div>
            }
          </div>
        </div>
      </div>

      <div class="flex-grow-1">
        <!-- right side -->
        <div
          class="bg-bs-grey-shade text-center py-3 font-sm-medium text-bs-grey-300 border-round-right"
          cdkDropList
          id="columnList"
          [cdkDropListData]="columnDropList"
          [cdkDropListConnectedTo]="['questionList']"
          (cdkDropListDropped)="onDrop($event, 'column')"
          [class.drop-active]="columnActive"
          (cdkDropListEntered)="onDropListEnter($event)"
          (cdkDropListExited)="onDropListExit($event)"
        >
          COLUMNS
        </div>
        <div class="d-flex">
          <div
            class="rows-label bg-bs-grey-shade text-center px-3 font-sm-medium text-bs-grey-300"
            cdkDropList
            id="rowList"
            [cdkDropListData]="rowDropList"
            [cdkDropListConnectedTo]="['questionList']"
            (cdkDropListDropped)="onDrop($event, 'row')"
            [class.drop-active]="rowActive"
            (cdkDropListEntered)="onDropListEnter($event)"
            (cdkDropListExited)="onDropListExit($event)"
          >
            ROWS
          </div>

          <div class="w-75 p-3">
            @if (generatedTable) {
              
            }
            <table class="table-wrapper w-100">
              <thead>
                <tr>
                  <th rowspan="2" class="text-center">Rows / Columns</th>
                  <!-- Column headers -->
                  <ng-container *ngFor="let colQ of columnQuestions">
                    <th
                      [attr.colspan]="colQ.answers.length"
                      class="text-center"
                    >
                      {{ colQ.questionText }}
                    </th>
                  </ng-container>
                </tr>
                <tr>
                  <!-- Column answers -->
                  <ng-container *ngFor="let colQ of columnQuestions">
                    <th *ngFor="let ans of colQ.answers" class="text-center">
                      {{ ans }}
                    </th>
                  </ng-container>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let rowQ of rowQuestions">
                  <tr *ngFor="let ans of rowQ.answers; let i = index">
                    <td>{{ ans }}</td>
                    <td *ngFor="let _ of tableMatrix[i]">{{ "nn" }}</td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
            
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center p-2">
      <!-- footer -->

      <div>Tip: Drag & drop the variables in the right side space</div>
      <div class="d-flex align-items-center column-gap-3">
        <button class="btn-bs-grey-100-outline text-bs-grey-100">Reset</button>
        <button class="btn-bs-grey-100">Cancel</button>
        <button class="btn-bs-purple-500">Confirm & Save</button>
      </div>
    </div>
  </div>
</app-common-dialog>

TS:

import { CommonDialogComponent } from "@/app/components/common-dialog/common-dialog.component";
import { CustomDropdownComponent } from "@/app/components/custom-dropdown/custom-dropdown.component";
import {
  CdkDrag,
  CdkDragDrop,
  CdkDragEnter,
  CdkDragExit,
  CdkDropList,
} from "@angular/cdk/drag-drop";
import { CommonModule } from "@angular/common";
import {
  Component,
  ElementRef,
  EventEmitter,
  Input,
  Output,
  ViewChild,
} from "@angular/core";
import { FormsModule, ReactiveFormsModule } from "@angular/forms";
import { InputSwitchModule } from "primeng/inputswitch";
interface Question {
  id: string;
  question: string;
  answers: string[];
}

interface ColumnTable {
  type: "column";
  qid: string;
  questionText: string;
  headers: string[];
  values: string[];
}

interface RowTable {
  type: "row";
  qid: string;
  questionText: string;
  rows: { answer: string; count: string }[];
}

interface ColumnQuestion {
  id: string;
  questionText: string;
  answers: string[];
}

interface RowQuestion {
  id: string;
  questionText: string;
  answers: string[];
}

interface Cell {
  value: string;
}

type GeneratedTable = ColumnTable | RowTable | null;

@Component({
  selector: "app-custom-data-table",
  imports: [
    CommonDialogComponent,
    CdkDrag,
    CdkDropList,
    CustomDropdownComponent,
    FormsModule,
    InputSwitchModule,
    CommonModule,
  ],
  templateUrl: "./custom-data-table.component.html",
  styleUrl: "./custom-data-table.component.scss",
})
export class CustomDataTableComponent {
  @Output() close = new EventEmitter<void>();
  @Input() visible: boolean = false;
  selectedQuestionId: string | null = null;
  generatedTable: GeneratedTable = null; // holds the generated table data
  rowDropList: Question[] = [];
  columnDropList: Question[] = [];
  rowActive = false;
  columnActive = false;
  selectedPosition: string = "";
  isHideEnabled = true;
  mode: "normal" | "compact" = "normal";
  @ViewChild("searchInput") searchInput!: ElementRef<HTMLInputElement>;
  showSearch: boolean = true;

  // multiple question card drag and drop
  columnQuestions: ColumnQuestion[] = [];
  rowQuestions: RowQuestion[] = [];
  tableMatrix: Cell[][] = [];

  focusSearchInput(): void {
    this.searchInput.nativeElement.focus();
  }

  onClose() {
    this.close.emit();
  }

  questions: Question[] = [
    {
      id: "Q1",
      question: "What is your age?",
      answers: ["18-25", "26-35", "36-45", "45+"],
    },
    {
      id: "Q2",
      question: "What is your gender?",
      answers: ["Male", "Female", "Non-binary", "Prefer not to say"],
    },
    {
      id: "Q3",
      question: "What is your age?",
      answers: ["18-25", "26-35", "36-45", "45+"],
    },
    {
      id: "Q4",
      question: "What is your age?",
      answers: ["18-25", "26-35", "36-45", "45+"],
    },
    {
      id: "Q5",
      question: "What is your gender?",
      answers: ["Male", "Female", "Non-binary", "Prefer not to say"],
    },
    {
      id: "Q6",
      question: "What is your gender?",
      answers: ["Male", "Female", "Non-binary", "Prefer not to say"],
    },
  ];

  positions = [
    { label: "Row", value: "row" },
    { label: "Column", value: "column" },
  ];

  selectQuestion(id: string) {
    this.selectedQuestionId = id;
  }

  get selectedAnswers(): string[] {
    const q = this.questions.find((x) => x.id === this.selectedQuestionId);
    return q ? q.answers : [];
  }

  // Drag and drop question code:
  onDrop(event: CdkDragDrop<Question[]>, dropType: "row" | "column") {
    const q = event.item.data;

    if (!q) return;

    if (dropType === "column") {
      this.columnQuestions.push({
        id: q.id,
        questionText: q.question,
        answers: q.answers,
      });
      this.columnActive = false;
    } else {
      this.rowQuestions.push({
        id: q.id,
        questionText: q.question,
        answers: q.answers,
      });
      this.rowActive = false;
    }

    this.generateMatrix();
  }

  generateMatrix(): void {
    if (this.rowQuestions.length === 0 || this.columnQuestions.length === 0) {
      this.tableMatrix = [];
      return;
    }

    // Flatten row answers
    const rowLabels: string[] = [];
    this.rowQuestions.forEach((rowQ) => {
      rowLabels.push(...rowQ.answers);
    });

    // Flatten column headers
    const colLabels: string[] = [];
    this.columnQuestions.forEach((colQ) => {
      colLabels.push(...colQ.answers);
    });

    // Create table matrix with Cell objects
    this.tableMatrix = rowLabels.map(() =>
      colLabels.map(() => ({ value: "nn" }))
    );
  }

  generateColumnTable(question: Question) {
    this.generatedTable = {
      type: "column",
      qid: question.id,
      questionText: question.question,
      headers: question.answers,
      values: question.answers.map(() => "nn"),
    };
  }

  generateRowTable(question: Question) {
    this.generatedTable = {
      type: "row",
      qid: question.id,
      questionText: question.question,
      rows: question.answers.map((ans) => ({
        answer: ans,
        count: "nn",
      })),
    };
  }

  onDropListEnter(event: CdkDragEnter<Question[]>) {
    if (event.container.id === "columnList") this.columnActive = true;
    if (event.container.id === "rowList") this.rowActive = true;
  }

  onDropListExit(event: CdkDragExit<Question[]>) {
    if (event.container.id === "columnList") this.columnActive = false;
    if (event.container.id === "rowList") this.rowActive = false;
  }

  toggleVisibility() {
    console.log("");
  }

  setMode(m: "normal" | "compact") {
    this.mode = m;
  }

  // multiple question card drag and drop
}


.question-card{
  padding:18px 108px 18px 24px;
  border:1.5px solid #E8E8E9;
}

.search-section{
  border:1.5px solid #E8E8E9;
}

.question-card.active {
  background: #F4E8FF;
}

.left-question-section{
  width: 330px;
}

/* ROWS (vertical centered) */
.rows-label {
  writing-mode: sideways-lr;
  text-orientation: sideways-right;
  height: 65vh;
}

.pointer{
  cursor: pointer;
}


.answer-card {
  margin-bottom: 2px;
}

.question-drag-section{
  border:1.5px solid #E8E8E9;
}

// drag and drop styles

.cdk-drag-preview {
  background: #fff;
  padding: 12px;
  border: 1px solid #ccc;
}

.cdk-drag-placeholder {
  opacity: 0;
}

.table-content table {
  border-collapse: collapse;
}

.table-content td,
.table-content th {
  padding: 8px;
  border: 1px solid #ddd;
}


//----------------------------------------------------------------------------------
.drop-active {
  background-color: #F4E8FF !important;
  border: 2px dashed #B388F5 !important;
  transition: 0.2s ease-in-out;
  color:#8D1CFF;
  font-weight: 500;
}

.rows-label {
  max-width: 60px;
}

#columnList{
  max-height: 60px;
}

.table-wrapper{
  border:1.5px solid #E8E8E9;
}

.table-border{
  border:1.5px solid #E8E8E9;
}


// button styles
.outline-btn{
  border:1.5px solid #E8E8E9;
  border-radius: 24px;
  padding:12px 16px;
  background-color: white;
  color:#66666C;
}

.button-excel{
  border:1.5px solid #E8E8E9;
  border-radius: 24px;
  padding:12px 16px;
  background-color: white;
  color:#000000;
}


// toggle button styles section
.mode-toggle {
  display: flex;
  background: #fff;
  border: 1px solid #E8E8E9;
  border-radius: 24px;
  overflow: hidden;
  width: fit-content;
}

.toggle-option {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 16px;
  color: #66666C;
  border-right: 1px solid #E8E8E9;
  transition: 0.2s ease;

  &:last-child {
    border-right: none;
  }

  &.active {
    background: #F4E8FF;
    color: #8D1CFF;
    font-weight: 600;
  }
}
